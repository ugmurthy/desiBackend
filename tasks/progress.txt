## Codebase Patterns
- Use `type` imports for TypeScript types with verbatimModuleSyntax enabled (e.g., `import type { FastifyPluginAsync }`)
- Run `bun run typecheck` to verify TypeScript correctness
- SQLite: Use Bun's built-in `bun:sqlite` module for database operations
- Admin DB path: `~/.desiAgent/admin.db`
- Tenant DB path: `~/.desiAgent/tenants/{tenant_id}/agent.db` - use `getTenantDbPath(tenantId)` from user-schema.ts
- Use bcrypt for password/API key hashing (cost factor 12)
- All timestamps stored as Unix timestamps (seconds)
- User schema initialization: Use `initializeTenantUserSchema(tenantId)` which handles directory creation and returns the DB
---

## 2026-01-22 - US-001
Thread: https://ampcode.com/threads/T-019be5cf-5610-7741-b671-11973549e39a
- Implemented Bootstrap CLI Command
- Files changed: scripts/bootstrap.ts, package.json
- **Learnings for future iterations:**
  - The `--force` flag is parsed from `process.argv.slice(2)`
  - CLI entry point is scripts/bootstrap.ts, to be extended by bootstrap service in US-009
  - Script uses async main() pattern with proper exit codes
---

## 2026-01-22 - US-002
Thread: https://ampcode.com/threads/T-019be5d0-90b8-701d-8699-d7a799023930
- Implemented Admin Database Schema Extensions
- Files changed: src/db/admin-schema.ts
- **Learnings for future iterations:**
  - All schema tables are created in single `initializeAdminDatabase()` call using multi-statement exec
  - TypeScript interfaces defined for SuperAdmin, AdminApiKey, and Agent types
  - SQLite booleans stored as INTEGER (0 or 1) - see `active` field in agents table
  - UNIQUE constraint added using `UNIQUE(name, version)` syntax in table definition
---

## 2026-01-22 - US-003
Thread: https://ampcode.com/threads/T-019be5d0-90b8-701d-8699-d7a799023930
- Implemented Super Admin Creation service
- Files changed: src/services/super-admin.ts
- **Learnings for future iterations:**
  - Super admin service is in src/services/super-admin.ts
  - `createSuperAdmin()` returns `{ admin, created }` to indicate if admin was newly created or already existed
  - Reads ADMIN_EMAIL and ADMIN_NAME from env vars, with defaults
  - Uses bcrypt with cost factor 12 for password hashing (pattern in Codebase Patterns)
  - `force` option updates existing admin instead of skipping
---

## 2026-01-22 - US-004
Thread: https://ampcode.com/threads/T-019be5d4-f29d-75c5-85e9-a5fc01abede3
- Implemented Admin API Key Generation service
- Files changed: src/services/admin-api-key.ts
- **Learnings for future iterations:**
  - Admin API key service is in src/services/admin-api-key.ts
  - Key format: `desi_sk_admin_{random32chars}`, prefix stored as `desi_sk_admin_xxxx` (first 4 chars of random)
  - `createAdminApiKey()` returns `{ apiKey, fullKey, created }` - fullKey is null if key already exists
  - Key saved to ~/.desiAgent/admin-key.txt with 600 permissions
  - With `--force`, existing key is revoked (revokedAt set) before creating new one
  - Uses `crypto.getRandomValues()` for secure random generation
---

## 2026-01-22 - US-005
Thread: https://ampcode.com/threads/T-019be5d6-f6cc-77d7-af9b-ddacf33a60c3
- Implemented User Table Schema for tenant databases
- Files changed: src/db/user-schema.ts
- **Learnings for future iterations:**
  - User schema is in src/db/user-schema.ts
  - `getTenantDbPath(tenantId)` returns path to tenant's agent.db file
  - `initializeTenantUserSchema(tenantId)` creates tenant directory, database, and initializes user schema
  - Tenant DB path follows pattern: ~/.desiAgent/tenants/{tenantId}/agent.db
  - User role is typed as `"admin" | "member" | "viewer"`
---


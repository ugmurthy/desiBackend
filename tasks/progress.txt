## Codebase Patterns
- Use `type` imports for TypeScript types with verbatimModuleSyntax enabled (e.g., `import type { FastifyPluginAsync }`)
- Run `bun run typecheck` to verify TypeScript correctness
- SQLite: Use Bun's built-in `bun:sqlite` module for database operations
- Admin DB path: `~/.desiAgent/admin.db`
- Tenant DB path: `~/.desiAgent/tenants/{tenant_id}/agent.db` - use `getTenantDbPath(tenantId)` from user-schema.ts
- Use bcrypt for password/API key hashing (cost factor 12)
- All timestamps stored as Unix timestamps (seconds)
- User schema initialization: Use `initializeTenantUserSchema(tenantId)` which handles directory creation and returns the DB
- resource_ownership table lives in tenant's agent.db alongside dags/executions/sub_steps
- Use SQL JOINs for list operations rather than fetch-then-filter (performance)
- userId comes from `request.auth.user.id` set by authenticate middleware
- tenantDb comes from `request.auth.tenantDb` for direct DB access
- For list filtering, use getOwnedResourceIds() then filter after SDK fetch (SDK doesn't support JOIN)
---

## 2026-02-04 - US-001, US-002, US-003, US-004, US-005
Thread: https://ampcode.com/threads/T-019c2805-760b-741e-9793-7c060ea94658
- Implemented resource_ownership table schema with unique index on (resourceType, resourceId)
- Added insertResourceOwnership helper function called in POST /dags and POST /dags/:id/execute routes
- Added checkResourceOwnership and getOwnedResourceIds helper functions
- Updated GET /dags to filter by ownership using getOwnedResourceIds + Set-based filtering
- Files changed: src/db/user-schema.ts, src/routes/v2/dags.ts
- **Learnings for future iterations:**
  - SDK client (from @ugm/desiagent) abstracts DB access, so ownership filtering requires post-fetch filtering
  - Use Set for O(1) lookups when filtering large lists
  - Pagination needs to be applied after ownership filtering, not before
---

## 2026-02-04 - US-006, US-007, US-008, US-009, US-010
Thread: https://ampcode.com/threads/T-019c280b-5d12-743e-ad6b-b0ddeaf5f1c6
- US-006: Added 403 ownership checks to GET/PATCH/DELETE /dags/:id and POST /dags/:id/execute
- US-007: Updated GET /executions to filter by ownership using getOwnedResourceIds + Set filtering
- US-008: Added 403 ownership checks to all single execution endpoints (get, details, sub-steps, delete, resume)
- US-009: Created new /artifacts/:userId route to list file artifacts from readFile/writeFile tools
- US-010: Created new /dags/executions/:executionId route to get all DAG executions by any execution ID
- Files changed: src/routes/v2/dags.ts, src/routes/v2/executions.ts, src/routes/v2/artifacts.ts, src/app.ts
- **Learnings for future iterations:**
  - Check existence before ownership for proper 404 vs 403 ordering
  - execution.dagId can be null, always guard against it
  - When casting SDK types, use `as unknown as T` for complex type conversions
- Migration scripts go in scripts/ directory and may need `git add -f` due to .gitignore
---

## 2026-02-04 - US-011
Thread: https://ampcode.com/threads/T-019c281d-02c8-72b8-888d-b73332c35f17
- Created migration script scripts/migrate-ownership.ts
- Script iterates all tenant DBs, finds user by email, assigns ownership of all DAGs and executions
- Added npm script: `bun run migrate:ownership`
- Script is idempotent (checks for existing ownership before insert)
- Files changed: scripts/migrate-ownership.ts, package.json
- **Learnings for future iterations:**
  - Scripts directory may be in .gitignore, use `git add -f` to force add
  - Tenant DBs are at ~/.desiAgent/tenants/{tenantId}/agent.db
  - initializeResourceOwnershipSchema() creates table if missing (useful for migration)
---


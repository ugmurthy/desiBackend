## Codebase Patterns
- Use `type` imports for TypeScript types with verbatimModuleSyntax enabled (e.g., `import type { FastifyPluginAsync }`)
- Run `bun run typecheck` to verify TypeScript correctness
- Health endpoint pattern: Register routes with prefix in app.ts, export as default from route file
- Use `fastify-plugin` (fp) wrapper for plugins that need to be encapsulated properly
- SQLite: Use Bun's built-in `bun:sqlite` module for database operations
- Admin DB path: `~/.desiAgent/admin.db`
- Tenant DB path: `~/.desiAgent/tenants/{tenant_id}/agent.db`
---

## 2026-01-22 - US-001
Thread: https://ampcode.com/threads/T-019be511-0bf1-70ac-9194-020f8302229a
- Initialized Bun project with Fastify framework
- Installed dependencies: fastify, @fastify/cors, @fastify/env, @fastify/multipart, @fastify/rate-limit, bcrypt
- Created project structure: src/routes/v2, src/services, src/plugins, src/middleware, src/db, src/types, src/utils, src/config
- Configured environment schema in src/config/env.ts
- Created health check endpoint at GET /api/v2/health returning { status: 'ok' }
- Files changed: package.json, tsconfig.json, src/index.ts, src/app.ts, src/config/env.ts, src/routes/v2/health.ts
- **Learnings for future iterations:**
  - Must use `import type` for TypeScript types due to verbatimModuleSyntax in tsconfig
  - Fastify env plugin uses `confKey` to define where config is accessible (app.config)
  - Route plugins should export default and be registered with prefix in app.ts
---

## 2026-01-22 - US-002
Thread: https://ampcode.com/threads/T-019be513-a932-7447-bbc3-4f758372af55
- Created global error handler plugin at src/plugins/error-handler.ts
- Implemented standard error format: { statusCode, error, message, details }
- Validation errors return 400 with field-level details
- Not found errors return 404
- Unhandled errors return 500 without leaking internals
- Files changed: src/plugins/error-handler.ts, src/app.ts, package.json
- **Learnings for future iterations:**
  - Use `fastify-plugin` (fp) to wrap plugins so they share scope with parent
  - Fastify error handler receives FastifyError which has optional statusCode and validation properties
  - ValidationError from Fastify's Ajv includes a `validation` array with field-level error details
---

## 2026-01-22 - US-003
Thread: https://ampcode.com/threads/T-019be514-e552-765a-a386-d0076f16e1dc
- Created admin database schema at src/db/admin-schema.ts
- Tenant table with fields: id (UUID), name, slug, status, plan, quotas (JSON), createdAt, updatedAt
- Admin database created at ~/.desiAgent/admin.db with auto-directory creation
- Database initialization function creates tables if not exist with proper indexes
- Files changed: src/db/admin-schema.ts
- **Learnings for future iterations:**
  - Use Bun's built-in `bun:sqlite` module - no additional dependencies needed
  - Use `mkdirSync` with `{ recursive: true }` to create directory hierarchy
  - Store JSON fields as TEXT type in SQLite
  - Use DEFAULT datetime('now') for automatic timestamp fields
---

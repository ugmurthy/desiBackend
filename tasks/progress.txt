## Codebase Patterns
- Use `type` imports for TypeScript types with verbatimModuleSyntax enabled (e.g., `import type { FastifyPluginAsync }`)
- Run `bun run typecheck` to verify TypeScript correctness
- SQLite: Use Bun's built-in `bun:sqlite` module for database operations
- Admin DB path: `~/.desiAgent/admin.db`
- Tenant DB path: `~/.desiAgent/tenants/{tenant_id}/agent.db` - use `getTenantDbPath(tenantId)` from user-schema.ts
- Use bcrypt for password/API key hashing (cost factor 12)
- All timestamps stored as Unix timestamps (seconds)
- User schema initialization: Use `initializeTenantUserSchema(tenantId)` which handles directory creation and returns the DB
- resource_ownership table lives in tenant's agent.db alongside dags/executions/sub_steps
- Use SQL JOINs for list operations rather than fetch-then-filter (performance)
- userId comes from `request.auth.user.id` set by authenticate middleware
- tenantDb comes from `request.auth.tenantDb` for direct DB access
- For list filtering, use getOwnedResourceIds() then filter after SDK fetch (SDK doesn't support JOIN)
---

## 2026-02-04 - US-001, US-002, US-003, US-004, US-005
Thread: https://ampcode.com/threads/T-019c2805-760b-741e-9793-7c060ea94658
- Implemented resource_ownership table schema with unique index on (resourceType, resourceId)
- Added insertResourceOwnership helper function called in POST /dags and POST /dags/:id/execute routes
- Added checkResourceOwnership and getOwnedResourceIds helper functions
- Updated GET /dags to filter by ownership using getOwnedResourceIds + Set-based filtering
- Files changed: src/db/user-schema.ts, src/routes/v2/dags.ts
- **Learnings for future iterations:**
  - SDK client (from @ugm/desiagent) abstracts DB access, so ownership filtering requires post-fetch filtering
  - Use Set for O(1) lookups when filtering large lists
  - Pagination needs to be applied after ownership filtering, not before
---


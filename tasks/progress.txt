## Codebase Patterns
- Use `type` imports for TypeScript types with verbatimModuleSyntax enabled (e.g., `import type { FastifyPluginAsync }`)
- Run `bun run typecheck` to verify TypeScript correctness
- Health endpoint pattern: Register routes with prefix in app.ts, export as default from route file
- Use `fastify-plugin` (fp) wrapper for plugins that need to be encapsulated properly
- SQLite: Use Bun's built-in `bun:sqlite` module for database operations
- Admin DB path: `~/.desiAgent/admin.db`
- Tenant DB path: `~/.desiAgent/tenants/{tenant_id}/agent.db`
- desiAgent client: Use TenantClientService.getClient(tenantId) to get/create clients per tenant
- API key lookup: Use api_key_tenant_map table in admin DB to find tenant by key prefix
- createApiKey requires tenantId parameter to register the key-tenant mapping
---

## 2026-01-22 - US-001
Thread: https://ampcode.com/threads/T-019be511-0bf1-70ac-9194-020f8302229a
- Initialized Bun project with Fastify framework
- Installed dependencies: fastify, @fastify/cors, @fastify/env, @fastify/multipart, @fastify/rate-limit, bcrypt
- Created project structure: src/routes/v2, src/services, src/plugins, src/middleware, src/db, src/types, src/utils, src/config
- Configured environment schema in src/config/env.ts
- Created health check endpoint at GET /api/v2/health returning { status: 'ok' }
- Files changed: package.json, tsconfig.json, src/index.ts, src/app.ts, src/config/env.ts, src/routes/v2/health.ts
- **Learnings for future iterations:**
  - Must use `import type` for TypeScript types due to verbatimModuleSyntax in tsconfig
  - Fastify env plugin uses `confKey` to define where config is accessible (app.config)
  - Route plugins should export default and be registered with prefix in app.ts
---

## 2026-01-22 - US-002
Thread: https://ampcode.com/threads/T-019be513-a932-7447-bbc3-4f758372af55
- Created global error handler plugin at src/plugins/error-handler.ts
- Implemented standard error format: { statusCode, error, message, details }
- Validation errors return 400 with field-level details
- Not found errors return 404
- Unhandled errors return 500 without leaking internals
- Files changed: src/plugins/error-handler.ts, src/app.ts, package.json
- **Learnings for future iterations:**
  - Use `fastify-plugin` (fp) to wrap plugins so they share scope with parent
  - Fastify error handler receives FastifyError which has optional statusCode and validation properties
  - ValidationError from Fastify's Ajv includes a `validation` array with field-level error details
---

## 2026-01-22 - US-003
Thread: https://ampcode.com/threads/T-019be514-e552-765a-a386-d0076f16e1dc
- Created admin database schema at src/db/admin-schema.ts
- Tenant table with fields: id (UUID), name, slug, status, plan, quotas (JSON), createdAt, updatedAt
- Admin database created at ~/.desiAgent/admin.db with auto-directory creation
- Database initialization function creates tables if not exist with proper indexes
- Files changed: src/db/admin-schema.ts
- **Learnings for future iterations:**
  - Use Bun's built-in `bun:sqlite` module - no additional dependencies needed
  - Use `mkdirSync` with `{ recursive: true }` to create directory hierarchy
  - Store JSON fields as TEXT type in SQLite
  - Use DEFAULT datetime('now') for automatic timestamp fields
---

## 2026-01-22 - US-004
Thread: https://ampcode.com/threads/T-019be515-f1b6-7019-b66d-bea44e1f49e5
- Created per-tenant user schema at src/db/user-schema.ts
- User table with fields: id (UUID), email, name, role (admin|member|viewer), createdAt, updatedAt
- Tenant databases at ~/.desiAgent/tenants/{tenant_id}/agent.db with auto-directory creation
- Exported UserRole type alias and getTenantDbPath utility function
- Files changed: src/db/user-schema.ts
- **Learnings for future iterations:**
  - Tenant DBs follow same pattern as admin DB but are located at ~/.desiAgent/tenants/{tenant_id}/agent.db
  - initializeTenantUserSchema returns a Database instance that caller can use
  - Export a UserRole type for use in other modules needing role validation
---

## 2026-01-22 - US-005
Thread: https://ampcode.com/threads/T-019be516-b1b9-7298-9a4b-281d4e5c0a26
- Created API key schema at src/db/api-key-schema.ts with ApiKey table
- ApiKey fields: id, userId, name, keyPrefix, keyHash (bcrypt), scopes (JSON), expiresAt, createdAt
- Created src/services/api-key.ts with create, validate, list, revoke functions
- API key format: desi_sk_{env}_{random} (e.g., desi_sk_live_abc123def456...)
- Keys stored as bcrypt hashes, only prefix returned after creation
- Files changed: src/db/api-key-schema.ts, src/services/api-key.ts
- **Learnings for future iterations:**
  - API key prefix extraction: slice to `indexOf("_", 10) + 1 + KEY_PREFIX_LENGTH` to capture `desi_sk_live_` plus 8 chars
  - Use bcrypt `hash()` and `compare()` for secure API key storage and validation
  - initializeApiKeySchema must be called on a tenant database after initializeTenantUserSchema
  - Return fullKey only once at creation; subsequent queries only show keyPrefix
---

## 2026-01-22 - US-006
Thread: https://ampcode.com/threads/T-019be517-e6ea-72ad-ac64-a39d2a97460c
- Created TenantClientService at src/services/tenant-client.ts
- Added @ugm/desiagent as local dependency (file:../desiAgent)
- TenantClientService manages desiAgent client instances keyed by tenant ID
- getClient(tenantId) returns or creates client with tenant-specific database path
- Includes removeClient() and shutdownAll() for proper cleanup
- Singleton pattern with initializeTenantClientService() and getTenantClientService()
- Files changed: package.json, bun.lock, src/services/tenant-client.ts
- **Learnings for future iterations:**
  - Use `file:../desiAgent` syntax to link local packages in Bun
  - TenantClientService requires LLM config (provider, API keys, model) at initialization
  - Disable autoStartScheduler for backend clients (scheduler managed separately)
  - Client instances are cached by tenant ID to avoid repeated initialization
---

## 2026-01-22 - US-007
Thread: https://ampcode.com/threads/T-019be51a-35f8-776d-86bb-d5609a06442b
- Created auth middleware at src/middleware/authenticate.ts
- Validates Authorization: Bearer desi_sk_... header format
- Added api_key_tenant_map table to admin DB for quick tenant lookup by key prefix
- Updated createApiKey to require tenantId and register key-tenant mapping
- Updated revokeApiKey to remove mapping when key is deleted
- Added ensureRole helper for role-based access control
- Files changed: src/middleware/authenticate.ts, src/db/admin-schema.ts, src/services/api-key.ts
- **Learnings for future iterations:**
  - API keys are stored in tenant DBs but need a lookup table in admin DB to find which tenant owns the key
  - Use api_key_tenant_map.keyPrefix to quickly route auth requests to the correct tenant DB
  - Always check tenant.status === "active" before allowing authenticated requests
  - Middleware attaches auth context to request.auth for downstream handlers
---
